<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CineMatch | Premium Movie Picker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: #0f172a; 
      color: #f8fafc;
      background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
      min-height: 100vh;
    }
    .glass { 
      background: rgba(255, 255, 255, 0.03); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .poster-gradient {
      background: linear-gradient(to top, rgba(15, 23, 42, 0.9) 0%, transparent 100%);
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // --- ICON COMPONENTS (Simplified Lucide clones) ---
    const Icon = ({ name }) => {
      const icons = {
        play: <path d="M5 3l14 9-14 9V3z" />,
        upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" />,
        check: <path d="M20 6L9 17l-5-5" />,
        refresh: <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />,
        chevronRight: <path d="M9 18l6-6-6-6" />,
        star: <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
      };
      return (
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          {icons[name]}
        </svg>
      );
    };

    // --- CONSTANTS ---
    const TMDB_KEY = "YOUR_TMDB_API_KEY"; // Ensure this is set
    const STREAMING_OPTIONS = ["Netflix", "Max", "Disney Plus", "Hulu", "Amazon Prime Video", "Apple TV Plus", "Paramount Plus"];

    const MoviePicker = () => {
      const [step, setStep] = useState('upload'); // upload, quiz, loading, results
      const [apiKey, setApiKey] = useState(localStorage.getItem('tmdb_key') || '');
      const [rawList, setRawList] = useState([]);
      const [loadingStatus, setLoadingStatus] = useState('');
      const [progress, setProgress] = useState(0);
      const [results, setResults] = useState([]);
      
      // User Preferences
      const [prefs, setPrefs] = useState({
        streaming: [],
        vibe: 'any', // cozy, intense, mindless, masterpiece
        genreWeights: {},
        minRating: 6
      });

      useEffect(() => {
        if(apiKey) localStorage.setItem('tmdb_key', apiKey);
      }, [apiKey]);

      // --- UTILS: CSV PARSING ---
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          const rows = text.split('\n').slice(1);
          const movies = rows.map(row => {
            const cols = row.split(',');
            return { title: cols[0]?.replace(/"/g, ''), year: cols[1] };
          }).filter(m => m.title);
          setRawList(movies);
          setStep('quiz');
        };
        reader.readAsText(file);
      };

      // --- LOGIC: BATCHED ENRICHMENT ---
      const startProcessing = async () => {
        setStep('loading');
        const enriched = [];
        const BATCH_SIZE = 8;
        
        for (let i = 0; i < rawList.length; i += BATCH_SIZE) {
          const batch = rawList.slice(i, i + BATCH_SIZE);
          setLoadingStatus(`Analyzing ${i} of ${rawList.length} movies...`);
          setProgress(Math.round((i / rawList.length) * 100));

          const batchData = await Promise.all(batch.map(async (m) => {
            try {
              // 1. Search Movie
              const searchRes = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(m.title)}&year=${m.year}`).then(r => r.json());
              const details = searchRes.results?.[0];
              if (!details) return null;

              // 2. Fetch Providers & Images (Parallel)
              const [extra, providers] = await Promise.all([
                fetch(`https://api.themoviedb.org/3/movie/${details.id}?api_key=${apiKey}&append_to_response=images`).then(r => r.json()),
                fetch(`https://api.themoviedb.org/3/movie/${details.id}/watch/providers?api_key=${apiKey}`).then(r => r.json())
              ]);

              const watchData = providers.results?.US?.flatrate?.map(p => p.provider_name) || [];
              
              // Score Calculation
              let score = details.vote_average * 10;
              
              // Streaming Match (Huge boost)
              const hasService = watchData.some(s => prefs.streaming.includes(s));
              if (prefs.streaming.length > 0) {
                score *= hasService ? 1.5 : 0.2; // Penalize heavily if not on user's services
              }

              // Vibe Match
              if (prefs.vibe === 'cozy' && [35, 10751, 14].some(g => details.genre_ids.includes(g))) score *= 1.3;
              if (prefs.vibe === 'masterpiece' && details.vote_average > 8) score *= 1.5;

              return {
                ...details,
                posters: extra.images?.posters?.slice(0, 6).map(p => `https
